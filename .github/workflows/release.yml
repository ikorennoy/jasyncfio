name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version"
        required: true
      passphrase:
        description: "GPG passphrase"
        required: true

jobs:
  build:
    runs-on: ubuntu-20.04
    strategy:
      matrix:
        arch:
          - amd64
#          - arm64
    name: Release on ${{ matrix.arch }}
    steps:
      - name: Install gpg secret key
        run: |
          export GPG_TTY=$(tty)
          echo -n "${{ secrets.GPG_PRIVATE_KEY }}" | base64 --decode | gpg --batch --import
          gpg --list-secret-keys --keyid-format LONG
          echo -n "${{ secrets.GPG_PRIVATE_KEY }}" | base64 --decode > $GITHUB_WORKSPACE/release.gpg
      - name: Git checkout
        uses: actions/checkout@v2
      - name: Update System
        run: sudo apt-get update -q -y
      - name: Install qemu
        run: sudo apt-get -qq install -y qemu qemu-user-static
      - name: Docker deps
        run: docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
      - name: Experimental Docker
        run: sudo cp .github/experimental-docker.json /etc/docker/daemon.json
      - name: Restart Docker
        run: sudo systemctl restart docker.service
      - name: pull docker image
        run: docker pull --platform $(echo ${{ matrix.arch }} | sed 's|-|/|g') ubuntu:20.04 || true
      - name: build in docker
        run: | 
          docker run -e S_USERNAME=${{ secrets.S_USERNAME }} -e S_PASSWORD=${{ secrets.S_PASSWORD }} -e VERSION=${{ github.event.inputs.version }} -e PASSPHRASE=${{ github.event.inputs.passphrase }} --rm --ulimit memlock=-1:-1 -v $GITHUB_WORKSPACE:/work ubuntu:20.04 /work/.github/workflows/build.sh release